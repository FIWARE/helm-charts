# endpoint-auth-service

![Version: 0.0.1](https://img.shields.io/badge/Version-0.0.1-informational?style=flat-square) ![AppVersion: 0.0.1](https://img.shields.io/badge/AppVersion-0.0.1-informational?style=flat-square)
A Helm chart for running the endpoint-auth-service on kubernetes.

## Maintainers

| Name | Email | Url |
| ---- | ------ | --- |
| wistefan | stefan.wiedemann@fiware.org |  |

## Additional Information

The chart contains the [endpoint-auth-service](https://github.com/wistefan/endpoint-auth-service) and components to add the sidecar proxy to target services.

### Components

The chart deploys the following components:
* the [endpoint-configuartion-service](https://github.com/wistefan/endpoint-auth-service/tree/initial-dev/src/endpoint-configuration-service) - configuration under the key "configService"
* (optional) the [configmap-updater](https://github.com/wistefan/endpoint-auth-service/tree/initial-dev/src/envoy-configmap-updater) - automatically updates the [configmap](./templates/configmap.yaml) to be used by the proxy
* (optional) the sidecar-injector - automatically injects the sidecar-proxy, configuration under the key "sidecarInjector"
* (optional) the [ishare-auth-provider](https://github.com/wistefan/endpoint-auth-service/tree/initial-dev/src/ishare-auth-provider) - configuration under the key "ishare"

### Sidecar-injection

The chart provides the capability to automatically inject the sidecar-proxy into pods. It makes use of [Mutating Admission Webhooks](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/).
The webhook gets executed on pod-creation and injects the sidecar, its init-containers and the volumes into the pod.

The injected elements are:
* the (container) [envoy-proxy](https://www.envoyproxy.io)
* the (container) [resource-updater](https://github.com/wistefan/endpoint-auth-service/tree/initial-dev/src/envoy-resource-updater) to trigger config reloads for envoy
* the (initContainer) [init-iptables](https://github.com/wistefan/endpoint-auth-service/tree/initial-dev/src/iptables-init) to redirect traffic to the proxy
* the (initContaienr) [resource-updater](https://github.com/wistefan/endpoint-auth-service/tree/initial-dev/src/envoy-resource-updater) to fill the initial-config-folder
* the (volume) envoy-configmap that mounts the config-map generated by the endpoint-configuration-service
* the (volume) envoy-config-folder that is shared between envoy and the resource-updater

Since the [injection-service](https://github.com/tumblr/k8s-sidecar-injector) does require certificate authentication, you should generate a cert/key as following:
(replace <sidecarInjector.fullname> with the name of the injector service)
```shell
openssl genrsa -out ca.key 2048
export COMMON_NAME=<sidecarInjector.fullname>
openssl req -x509 -new -nodes -key ca.key -subj "/CN=${COMMON_NAME}" -days 3650 -reqexts v3_req -extensions v3_ca -out ca.crt
```
and provide them under ```sidecarInjector.cert``` and ```sidecarInjector.key``` .

To select the pods that should get injected, they need to be annotated. The annotation-namespace can be configured via ```sidecarInjector.annotationNamespace```.
In addition to the namespace, ```request``` has to be added and the configuration-key ```envoy-sidecar``` needs to be set as its value.

An example would look like:

```yaml
  apiVersion: apps/v1
  kind: Deployment
    metadata:
      name: echo-server
  template:
    metadata:
      annotations:
        sidecar.k8s.fiware.org/request: "envoy-sidecar"
    spec:
      containers:
        - image: k8s.gcr.io/echoserver:1.4    
```

In order to allow proper namespace restrictions, the webhook can be restricted to certain namespaces with the configuration under the key ```sidecarInjector.restrictNamespace```.

With this example configuration:
```yaml
    sidecarInjector:
      restrictNamespace:
        enabled: true
        label: sidecar-injection
        value: enabled
```
only pods in namespaces labeled with ```sidecar-injection=enabled``` will get injected. The label can be applied via ```kubectl label namespace my-namespace sidecar-injection=enabled```

### Service Mesh compatibility

In its current version, the injected proxy will most probably(except some edge-cases) break any integration of the injected pod with a service-mesh like [istio](https://istio.io/)
or [linkerd](https://linkerd.io/), since they use similar iptables to redirect traffic to their own proxies. If the injected init-container sets up the iptables to forward every outgoing traffic
the sidecar-proxy, this will be disturbed. It's planned to offer native support for at least istio in the future(contributions for any mesh are welcome), but
for now only workarounds might be a possibility.

A potential workaround might be to setup the iptables, so that the traffic from the sidecar proxy does not directly get returned, but instead is also redirected to the mesh-proxy. Check the [init-iptables container](https://github.com/wistefan/endpoint-auth-service/tree/initial-dev/src/iptables-init)
for that.

## Source Code

* <https://github.com/wistefan/endpoint-auth-service>

## Values

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| authProvider.address | string | `"ishare-auth"` | address to the auth-service |
| authProvider.port | int | `8080` | port of the auth-service |
| configService.additionalAnnotations | object | `{}` | additional annotations for the deployment, if required |
| configService.additionalLabels | object | `{}` | additional labels for the deployment, if required |
| configService.additonalEnvVars | list | `[]` | a list of additional env vars to be set, check the endpoint-configuration-service documentation for all available options |
| configService.affinity | object | `{}` | affinity template ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity |
| configService.autoscaling.enabled | bool | `false` | should autoscaling be enabled for configService |
| configService.autoscaling.maxReplicas | int | `10` | maximum number of running pods |
| configService.autoscaling.metrics | list | `[]` | metrics to react on |
| configService.autoscaling.minReplicas | int | `1` | minimum number of running pods |
| configService.configmapUpdater.enabled | bool | `true` | should the updater be deployed? |
| configService.configmapUpdater.image.pullPolicy | string | `"IfNotPresent"` | specification of the image pull policy |
| configService.configmapUpdater.image.repository | string | `"quay.io/wi_stefan/envoy-configmap-updater"` | configmap updater image name ref: https://quay.io/repository/wi_stefan/envoy-configmap-updater |
| configService.configmapUpdater.image.tag | string | `"latest"` | tag of the image to be used |
| configService.db.password | string | `"pass"` | password for connecting the database |
| configService.db.url | string | `"jdbc:h2:mem:devDb;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE"` | host of the database to be used - be aware, defaults to an in-memory db |
| configService.db.user | string | `"ecs"` | user for connecting the database |
| configService.fullnameOverride | string | `""` | option to override the fullname config in the _helpers.tpl |
| configService.healthPort | int | `9090` | port to request health information at |
| configService.image.pullPolicy | string | `"IfNotPresent"` | specification of the image pull policy |
| configService.image.repository | string | `"quay.io/wi_stefan/endpoint-configuration-service"` | endpoint-configuration-service image name ref: https://quay.io/repository/wi_stefan/endpoint-configuration-service |
| configService.image.tag | string | `"latest"` | tag of the image to be used |
| configService.ingress.annotations | object | `{}` | annotations to be added to the ingress |
| configService.ingress.enabled | bool | `false` | should there be an ingress to connect configService with the public internet |
| configService.ingress.hosts | list | `[]` |  |
| configService.ingress.tls | list | `[]` |  |
| configService.livenessProbe.initialDelaySeconds | int | `30` |  |
| configService.livenessProbe.periodSeconds | int | `10` |  |
| configService.livenessProbe.successThreshold | int | `1` |  |
| configService.livenessProbe.timeoutSeconds | int | `30` |  |
| configService.nameOverride | string | `""` | option to override the name config in the _helpers.tpl |
| configService.nodeSelector | object | `{}` | selector template ref: https://kubernetes.io/docs/user-guide/node-selection/ |
| configService.port | int | `8080` | port that the endpoint-configuration-service container uses |
| configService.prometheus.enabled | bool | `true` | should prometheus scrape be enabled |
| configService.prometheus.path | string | `"/prometheus"` | path for prometheus scrape |
| configService.prometheus.port | int | `9090` | port prometheus scrape is available at |
| configService.readinessProbe.initialDelaySeconds | int | `31` |  |
| configService.readinessProbe.periodSeconds | int | `10` |  |
| configService.readinessProbe.successThreshold | int | `1` |  |
| configService.readinessProbe.timeoutSeconds | int | `30` |  |
| configService.replicaCount | int | `1` | initial number of target replications, can be different if autoscaling is enabled |
| configService.resources | object | `{}` |  |
| configService.revisionHistoryLimit | int | `3` | number of old replicas to be retained |
| configService.route.annotations | object | `{}` | annotations to be added to the route |
| configService.route.enabled | bool | `false` |  |
| configService.route.tls | object | `{}` | host to be used host: localhost -- tls configuration for the route |
| configService.service.annotations | object | `{}` | addtional annotations, if required |
| configService.service.port | int | `8080` | port to be used by the service |
| configService.service.type | string | `"ClusterIP"` | service type |
| configService.serviceAccount | object | `{"create":false}` | if a configService configService service account should be used, it can be configured here ref: https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/ |
| configService.serviceAccount.create | bool | `false` | specifies if the account should be created |
| configService.tolerations | list | `[]` | tolerations template ref: ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/ |
| configService.updateStrategy.rollingUpdate | object | `{"maxSurge":1,"maxUnavailable":0}` | new pods will be added gradually |
| configService.updateStrategy.rollingUpdate.maxSurge | int | `1` | number of pods that can be created above the desired amount while updating |
| configService.updateStrategy.rollingUpdate.maxUnavailable | int | `0` | number of pods that can be unavailable while updating |
| configService.updateStrategy.type | string | `"RollingUpdate"` | type of the update |
| fullnameOverride | string | `""` | option to override the fullname config in the _helpers.tpl |
| ishare.additionalAnnotations | object | `{}` | additional annotations for the deployment, if required |
| ishare.additionalLabels | object | `{}` | additional labels for the deployment, if required |
| ishare.affinity | object | `{}` | affinity template ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity |
| ishare.autoscaling.enabled | bool | `false` | should autoscaling be enabled for ishare |
| ishare.autoscaling.maxReplicas | int | `10` | maximum number of running pods |
| ishare.autoscaling.metrics | list | `[]` | metrics to react on |
| ishare.autoscaling.minReplicas | int | `1` | minimum number of running pods |
| ishare.enabled | bool | `true` | should the ishare-auth-provider be enabled? |
| ishare.fullnameOverride | string | `""` | option to override the fullname config in the _helpers.tpl |
| ishare.image.pullPolicy | string | `"IfNotPresent"` | specification of the image pull policy |
| ishare.image.repository | string | `"quay.io/wi_stefan/ishare-auth-provider"` | endpoint-configuration-service image name ref: https://quay.io/repository/wi_stefan/ishare-auth-provider |
| ishare.image.tag | string | `"latest"` | tag of the image to be used |
| ishare.ingress.annotations | object | `{}` | annotations to be added to the ingress |
| ishare.ingress.enabled | bool | `false` | should there be an ingress to connect ishare with the public internet |
| ishare.ingress.hosts | list | `[]` |  |
| ishare.ingress.tls | list | `[]` |  |
| ishare.nameOverride | string | `""` | option to override the name config in the _helpers.tpl |
| ishare.nodeSelector | object | `{}` | selector template ref: https://kubernetes.io/docs/user-guide/node-selection/ |
| ishare.port | int | `8080` | port that the ishare authprovider container uses |
| ishare.replicaCount | int | `1` | initial number of target replications, can be different if autoscaling is enabled |
| ishare.resources | object | `{}` |  |
| ishare.revisionHistoryLimit | int | `3` | number of old replicas to be retained |
| ishare.route.annotations | object | `{}` | annotations to be added to the route |
| ishare.route.enabled | bool | `false` |  |
| ishare.route.tls | object | `{}` | host to be used host: localhost -- tls configuration for the route |
| ishare.service.annotations | object | `{}` | addtional annotations, if required |
| ishare.service.port | int | `8080` | port to be used by the service |
| ishare.service.type | string | `"ClusterIP"` | service type |
| ishare.serviceAccount | object | `{"create":false}` | if a ishare specific service account should be used, it can be configured here ref: https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/ |
| ishare.serviceAccount.create | bool | `false` | specifies if the account should be created |
| ishare.storage.enabled | bool | `true` | should the config be persisted inside a pvc |
| ishare.storage.size | string | `"8G"` | how big should the pvc be |
| ishare.tolerations | list | `[]` | tolerations template ref: ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/ |
| ishare.updateStrategy.rollingUpdate | object | `{"maxSurge":1,"maxUnavailable":0}` | new pods will be added gradually |
| ishare.updateStrategy.rollingUpdate.maxSurge | int | `1` | number of pods that can be created above the desired amount while updating |
| ishare.updateStrategy.rollingUpdate.maxUnavailable | int | `0` | number of pods that can be unavailable while updating |
| ishare.updateStrategy.type | string | `"RollingUpdate"` | type of the update |
| nameOverride | string | `""` | option to override the name config in the _helpers.tpl |
| sidecar.image.pullPolicy | string | `"IfNotPresent"` | specification of the image pull policy |
| sidecar.image.repository | string | `"quay.io/wi_stefan/envoy"` | envoy image name ref: https://quay.io/repository/wi_stefan/envoy |
| sidecar.image.tag | string | `"latest"` | tag of the image to be used |
| sidecar.initConfig.pullPolicy | string | `"IfNotPresent"` | specification of the image pull policy |
| sidecar.initConfig.repository | string | `"quay.io/wi_stefan/envoy-resource-updater"` | image name ref: https://quay.io/repository/wi_stefan/envoy-resource-updater |
| sidecar.initConfig.tag | string | `"latest"` | tag of the image to be used |
| sidecar.initIptables.pullPolicy | string | `"IfNotPresent"` | specification of the image pull policy |
| sidecar.initIptables.repository | string | `"quay.io/wi_stefan/init-iptables"` | image name ref: https://quay.io/repository/wi_stefan/init-iptables |
| sidecar.initIptables.tag | string | `"latest"` | tag of the image to be used |
| sidecar.logLevel | string | `"trace"` |  |
| sidecar.port | int | `15001` |  |
| sidecar.updateConfig.pullPolicy | string | `"IfNotPresent"` | specification of the image pull policy |
| sidecar.updateConfig.repository | string | `"quay.io/wi_stefan/envoy-resource-updater"` | image name ref: https://quay.io/repository/wi_stefan/envoy-resource-updater |
| sidecar.updateConfig.tag | string | `"latest"` | tag of the image to be used |
| sidecar.userId | int | `1337` |  |
| sidecarInjector.additionalAnnotations | object | `{}` | additional annotations for the deployment, if required |
| sidecarInjector.additionalLabels | object | `{}` | additional labels for the deployment, if required |
| sidecarInjector.affinity | object | `{}` | affinity template ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity |
| sidecarInjector.annotationNamespace | string | `"sidecar.k8s.fiware.org"` | namespace of the annotation to be applied to the pod that should get injected. |
| sidecarInjector.cert | string | `"-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----\n"` | certificate to be used by the injector service in pem format |
| sidecarInjector.enabled | bool | `true` |  |
| sidecarInjector.fullnameOverride | string | `""` | option to override the fullname config in the _helpers.tpl |
| sidecarInjector.healthPort | int | `9000` | port that the health check is available at |
| sidecarInjector.image.pullPolicy | string | `"IfNotPresent"` | specification of the image pull policy |
| sidecarInjector.image.repository | string | `"tumblr/k8s-sidecar-injector"` | endpoint-configuration-service image name ref: https://hub.docker.com/r/mayankkr/sidecarinjector |
| sidecarInjector.image.tag | string | `"release-v0.5.0"` | tag of the image to be used |
| sidecarInjector.key | string | `"-----BEGIN RSA PRIVATE KEY-----\n...\n-----END RSA PRIVATE KEY-----\n"` | key to be used by the injector service |
| sidecarInjector.labelNamespace | string | `"sidecar.k8s.fiware.org"` | namespace of the label to find the configmap to inject. |
| sidecarInjector.livenessProbe.initialDelaySeconds | int | `30` |  |
| sidecarInjector.livenessProbe.periodSeconds | int | `10` |  |
| sidecarInjector.livenessProbe.successThreshold | int | `1` |  |
| sidecarInjector.livenessProbe.timeoutSeconds | int | `30` |  |
| sidecarInjector.logLevel | int | `2` | log level of the injector |
| sidecarInjector.nameOverride | string | `""` | option to override the name config in the _helpers.tpl |
| sidecarInjector.nodeSelector | object | `{}` | selector template ref: https://kubernetes.io/docs/user-guide/node-selection/ |
| sidecarInjector.overrideSidecarconfig | object | `{}` | override the generated config for the sidecar, if not sufficient |
| sidecarInjector.port | int | `8443` | port that the injector listens to |
| sidecarInjector.readinessProbe.initialDelaySeconds | int | `31` |  |
| sidecarInjector.readinessProbe.periodSeconds | int | `10` |  |
| sidecarInjector.readinessProbe.successThreshold | int | `1` |  |
| sidecarInjector.readinessProbe.timeoutSeconds | int | `30` |  |
| sidecarInjector.replicaCount | int | `1` | initial number of target replications, can be different if autoscaling is enabled |
| sidecarInjector.restrictNamespace.enabled | bool | `true` | should the injector be restricted to labeld namespaces? |
| sidecarInjector.restrictNamespace.label | string | `"sidecar-injection"` | label to apply to the namespaces |
| sidecarInjector.restrictNamespace.value | string | `"enabled"` | value to be set for the label |
| sidecarInjector.revisionHistoryLimit | int | `3` | number of old replicas to be retained |
| sidecarInjector.service.annotations | object | `{}` | addtional annotations, if required |
| sidecarInjector.service.port | int | `443` | port to be used by the service |
| sidecarInjector.service.type | string | `"ClusterIP"` | service type |
| sidecarInjector.serviceAccount | object | `{"create":false}` | if a sidecarInjector specific service account should be used, it can be configured here ref: https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/ |
| sidecarInjector.serviceAccount.create | bool | `false` | specifies if the account should be created |
| sidecarInjector.tolerations | list | `[]` | tolerations template ref: ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/ |

----------------------------------------------
Autogenerated from chart metadata using [helm-docs v1.5.0](https://github.com/norwoodj/helm-docs/releases/v1.5.0)