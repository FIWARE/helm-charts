{{- if and (eq .Values.registration.enabled true) (.Values.registration) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ccs.fullname" . }}-registration
  namespace: {{ $.Release.Namespace | quote }}
  labels:
    {{ include "ccs.labels" . | nindent 4 }}
data:
  init.sh: |-
    {{- if .Values.registration.prepScript }}
    # Prep script
    {{ .Values.registration.prepScript }} 
    {{- end }}
  
    # credentials config service registration
    {{- range .Values.registration.services }}

    curl -X 'POST' \
      'http://{{ include "ccs.fullname" $ }}:{{ $.Values.service.port }}/service' \
      -H 'accept: */*' \
      -H 'Content-Type: application/json' \
      -d '{
      "id": {{ .id | quote }},
      "defaultOidcScope": {{ .defaultOidcScope | quote }},
      "oidcScopes": {{- toJson .oidcScopes }}
    }'

    {{- end }}

{{- end }}
